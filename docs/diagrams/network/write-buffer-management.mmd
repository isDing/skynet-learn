graph TB
    subgraph BufferStructure["ğŸ“Š å†™ç¼“å†²åŒºç»“æ„"]
        WriteBuffer[wb: write_buffer]
        HighQueue[highé˜Ÿåˆ—<br/>æ§åˆ¶æ¶ˆæ¯ä¼˜å…ˆ]
        LowQueue[lowé˜Ÿåˆ—<br/>æ™®é€šæ•°æ®]
        TotalSize[wb_size<br/>æ€»ç¼“å†²åŒºå¤§å°]
    end
    
    subgraph QueueStructure["ğŸ”— é˜Ÿåˆ—ç»“æ„"]
        HighHead[high.head<br/>é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—å¤´]
        HighTail[high.tail<br/>é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—å°¾]
        LowHead[low.head<br/>ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å¤´]
        LowTail[low.tail<br/>ä½ä¼˜å…ˆçº§é˜Ÿåˆ—å°¾]
    end
    
    subgraph BufferNode["ğŸ“„ ç¼“å†²åŒºèŠ‚ç‚¹"]
        NodePtr[ptr<br/>æ•°æ®æŒ‡é’ˆ]
        NodeSize[sz<br/>æ•°æ®å¤§å°]
        NodeBuffer[buffer<br/>å®é™…æ•°æ®]
        NodeUser[userobject<br/>ç”¨æˆ·å¯¹è±¡æ ‡å¿—]
        NodeNext[next<br/>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ]
    end
    
    subgraph DirectWrite["âš¡ ç›´å†™æ¨¡å¼"]
        DirectCheck[æ£€æŸ¥å†™ç¼“å†²åŒºæ˜¯å¦ä¸ºç©º]
        DirectSend[send_socket<br/>ç›´æ¥å‘é€åˆ°å†…æ ¸]
        DirectResult[å‘é€ç»“æœåˆ¤æ–­]
    end
    
    subgraph BufferWrite["ğŸ“ ç¼“å†²å†™æ¨¡å¼"]
        AppendBuffer[append_sendbuffer<br/>æ·»åŠ åˆ°å†™ç¼“å†²åŒº]
        ChooseQueue[é€‰æ‹©é˜Ÿåˆ—<br/>highæˆ–low]
        AddToTail[æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨]
        UpdateSize[æ›´æ–°wb_size]
    end
    
    subgraph SendProcess["ğŸ“¤ å‘é€å¤„ç†"]
        SendHigh[å‘é€highé˜Ÿåˆ—<br/>ä¼˜å…ˆå¤„ç†æ§åˆ¶æ¶ˆæ¯]
        SendLow[å‘é€lowé˜Ÿåˆ—<br/>å¤„ç†æ™®é€šæ•°æ®]
        PartialSend[éƒ¨åˆ†å‘é€å¤„ç†<br/>æ›´æ–°ptrå’Œsz]
        CompleteNode[å®Œæ•´èŠ‚ç‚¹å‘é€<br/>é‡Šæ”¾èŠ‚ç‚¹å†…å­˜]
    end
    
    subgraph FlowControl["ğŸš¦ æµé‡æ§åˆ¶"]
        WarnSize[warn_size<br/>è­¦å‘Šé˜ˆå€¼]
        SizeCheck[æ£€æŸ¥ç¼“å†²åŒºå¤§å°]
        Warning[å‘é€è­¦å‘Šæ¶ˆæ¯<br/>SOCKET_WARNING]
        Blocking[é˜»å¡å†™å…¥<br/>é˜²æ­¢å†…å­˜çˆ†ç‚¸]
    end
    
    %% è¿æ¥å…³ç³»
    WriteBuffer --> HighQueue
    WriteBuffer --> LowQueue
    WriteBuffer --> TotalSize
    
    HighQueue --> HighHead
    HighQueue --> HighTail
    LowQueue --> LowHead
    LowQueue --> LowTail
    
    HighHead --> NodePtr
    HighTail --> NodePtr
    LowHead --> NodePtr
    LowTail --> NodePtr
    
    NodePtr --> NodeSize
    NodeSize --> NodeBuffer
    NodeBuffer --> NodeUser
    NodeUser --> NodeNext
    
    %% å¤„ç†æµç¨‹
    DirectCheck -->|ç©ºé—²| DirectSend
    DirectCheck -->|æœ‰æ•°æ®| AppendBuffer
    DirectSend --> DirectResult
    DirectResult -->|éƒ¨åˆ†å‘é€| AppendBuffer
    DirectResult -->|EAGAIN| AppendBuffer
    DirectResult -->|å®Œæˆ| End([å‘é€å®Œæˆ])
    
    AppendBuffer --> ChooseQueue
    ChooseQueue -->|æ§åˆ¶æ¶ˆæ¯| HighTail
    ChooseQueue -->|æ™®é€šæ•°æ®| LowTail
    HighTail --> AddToTail
    LowTail --> AddToTail
    AddToTail --> UpdateSize
    
    UpdateSize --> SizeCheck
    SizeCheck -->|è¶…è¿‡è­¦å‘Š| Warning
    SizeCheck -->|æ­£å¸¸| SendProcess
    Warning --> Blocking
    
    SendProcess --> SendHigh
    SendHigh -->|é˜Ÿåˆ—ç©º| SendLow
    SendHigh -->|æœ‰æ•°æ®| PartialSend
    SendLow --> PartialSend
    PartialSend -->|å®Œæˆ| CompleteNode
    PartialSend -->|éƒ¨åˆ†| UpdateNode[æ›´æ–°èŠ‚ç‚¹æŒ‡é’ˆ]
    CompleteNode --> NextNode[å¤„ç†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹]
    UpdateNode --> NextNode
    NextNode --> SendProcess
    
    %% æ ·å¼å®šä¹‰
    classDef structStyle fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef queueStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef nodeStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef directStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef bufferStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef sendStyle fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef flowStyle fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef endStyle fill:#ffcdd2,stroke:#d32f2f,stroke-width:2px
    
    class WriteBuffer,HighQueue,LowQueue,TotalSize structStyle
    class HighHead,HighTail,LowHead,LowTail queueStyle
    class NodePtr,NodeSize,NodeBuffer,NodeUser,NodeNext nodeStyle
    class DirectCheck,DirectSend,DirectResult directStyle
    class AppendBuffer,ChooseQueue,AddToTail,UpdateSize bufferStyle
    class SendHigh,SendLow,PartialSend,CompleteNode,SendProcess,UpdateNode,NextNode sendStyle
    class WarnSize,SizeCheck,Warning,Blocking flowStyle
    class End endStyle