# Skynet ç½‘ç»œå±‚æ¶æ„å›¾è¡¨

æœ¬ç›®å½•åŒ…å«Skynetç½‘ç»œå±‚çš„è¯¦ç»†æ¶æ„å›¾å’Œæµç¨‹å›¾ï¼Œä½¿ç”¨Mermaidæ ¼å¼åˆ›å»ºã€‚

## å›¾è¡¨åˆ—è¡¨

### 1. ç½‘ç»œå±‚æ•´ä½“æ¶æ„å›¾ (network-architecture.mmd)
å±•ç¤ºSkynetç½‘ç»œå±‚çš„äº”å±‚æ¶æ„ï¼š
- ğŸŒ åº”ç”¨å±‚ï¼šå„ç§æœåŠ¡ï¼ˆGateã€Clientã€Gameç­‰ï¼‰
- ğŸ”„ skynet_socketå±‚ï¼šsocket APIå’Œæ¶ˆæ¯åˆ†å‘
- âš™ï¸ socket_serverå±‚ï¼šsocketç®¡ç†å’Œæ§åˆ¶
- ğŸ”€ IOå¤šè·¯å¤ç”¨å±‚ï¼šepoll/kqueue/select
- ğŸ§ ç³»ç»Ÿå†…æ ¸å±‚ï¼šç½‘ç»œåè®®æ ˆå’Œç¡¬ä»¶

### 2. SocketçŠ¶æ€æœºå›¾ (socket-state-machine.mmd)
å®Œæ•´çš„socketçŠ¶æ€è½¬æ¢å›¾ï¼ŒåŒ…å«ï¼š
- INVALID â†’ RESERVE â†’ PLISTEN/CONNECTING/BIND
- LISTEN â†’ PACCEPT â†’ CONNECTED
- CONNECTED â†’ HALFCLOSE_READ/HALFCLOSE_WRITE
- å„çŠ¶æ€é—´çš„è½¬æ¢æ¡ä»¶å’Œè§¦å‘äº‹ä»¶

### 3. æ•°æ®æ¥æ”¶æµç¨‹å›¾ (data-receive-flow.mmd)
ä»ç½‘ç»œæ•°æ®åˆ°è¾¾åˆ°æœåŠ¡å¤„ç†çš„å®Œæ•´æµç¨‹ï¼š
- ç½‘ç»œæ•°æ®åˆ°è¾¾ â†’ epoll_wait â†’ socket_server_poll
- forward_message_tcp/udp â†’ æ¶ˆæ¯æ‰“åŒ…
- skynet_socket_poll â†’ forward_message
- skynet_context_push â†’ æœåŠ¡æ¶ˆæ¯é˜Ÿåˆ— â†’ æœåŠ¡å¤„ç†

### 4. æ•°æ®å‘é€æµç¨‹å›¾ (data-send-flow.mmd)
ä»æœåŠ¡å‘é€åˆ°ç½‘ç»œä¼ è¾“çš„å®Œæ•´æµç¨‹ï¼š
- æœåŠ¡è°ƒç”¨socket.write â†’ skynet_socket_send
- ç›´å†™/ç¼“å†²å†™æ¨¡å¼é€‰æ‹© â†’ æ§åˆ¶ç®¡é“ä¼ é€’
- ç½‘ç»œçº¿ç¨‹å¤„ç† â†’ epollç›‘å¬EPOLLOUT
- send_bufferå‘é€ â†’ åŒä¼˜å…ˆçº§é˜Ÿåˆ—å¤„ç†

### 5. socket_serveræ ¸å¿ƒæ•°æ®ç»“æ„å›¾ (socket-server-structure.mmd)
å±•ç¤ºsocket_serverçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼š
- socket_serverä¸»ç»“æ„ä½“ï¼ˆevent_fdã€æ§åˆ¶ç®¡é“ã€IDåˆ†é…å™¨ç­‰ï¼‰
- slot[MAX_SOCKET]æ•°ç»„å’Œsocketç»“æ„ä½“
- å†™ç¼“å†²åŒºåŒä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆhigh/lowï¼‰
- äº‹ä»¶æ•°ç»„å’Œäº‹ä»¶ç»“æ„ä½“

### 6. ç½‘ç»œçº¿ç¨‹ä¸å·¥ä½œçº¿ç¨‹äº¤äº’å›¾ (thread-interaction.mmd)
å±•ç¤ºç½‘ç»œçº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹æ± çš„äº¤äº’æœºåˆ¶ï¼š
- ç½‘ç»œçº¿ç¨‹ï¼šepoll_waitå¤„ç†ç½‘ç»œäº‹ä»¶
- æ§åˆ¶ç®¡é“ï¼šçº¿ç¨‹é—´é€šä¿¡æœºåˆ¶
- å…¨å±€æ¶ˆæ¯é˜Ÿåˆ—ï¼šå·¥ä½œçº¿ç¨‹ç«äº‰è·å–æ¶ˆæ¯
- åŒæ­¥æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7. Socket IDç®¡ç†æœºåˆ¶å›¾ (socket-id-management.mmd)
è¯¦ç»†å±•ç¤ºsocket IDçš„åˆ†é…å’Œç®¡ç†ï¼š
- åŸå­è®¡æ•°å™¨åˆ†é…ID
- HASHæ˜ å°„åˆ°æ§½ä½
- ç‰ˆæœ¬å·æœºåˆ¶é˜²æ­¢ABAé—®é¢˜
- æ§½ä½å¤ç”¨å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

### 8. å†™ç¼“å†²åŒºç®¡ç†å›¾ (write-buffer-management.mmd)
å±•ç¤ºåŒä¼˜å…ˆçº§é˜Ÿåˆ—çš„å†™ç¼“å†²åŒºè®¾è®¡ï¼š
- highé˜Ÿåˆ—ï¼šæ§åˆ¶æ¶ˆæ¯ä¼˜å…ˆ
- lowé˜Ÿåˆ—ï¼šæ™®é€šæ•°æ®
- ç›´å†™æ¨¡å¼å’Œç¼“å†²å†™æ¨¡å¼
- æµé‡æ§åˆ¶å’Œè­¦å‘Šæœºåˆ¶

## ä½¿ç”¨è¯´æ˜

### åœ¨çº¿é¢„è§ˆ
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·åœ¨çº¿é¢„è§ˆMermaidå›¾è¡¨ï¼š
- [Mermaid Live Editor](https://mermaid.live/)
- [GitHubæ¸²æŸ“](https://github.com) (ç›´æ¥åœ¨READMEä¸­å¼•ç”¨)
- [VS Code Mermaidæ’ä»¶](https://marketplace.visualstudio.com/items?itemName=bierner.markdown-mermaid)

### æœ¬åœ°æ¸²æŸ“
```bash
# å®‰è£…mermaid-cli
npm install -g @mermaid-js/mermaid-cli

# æ¸²æŸ“ä¸ºPNG
mmdc -i network-architecture.mmd -o network-architecture.png

# æ¸²æŸ“ä¸ºSVG
mmdc -i network-architecture.mmd -o network-architecture.svg
```

### åœ¨Markdownä¸­ä½¿ç”¨
````markdown
```mermaid
graph TB
    %% ä»æ–‡ä»¶ä¸­å¤åˆ¶å›¾è¡¨å†…å®¹
```
````

## é¢œè‰²è¯´æ˜

æ¯ä¸ªå›¾è¡¨éƒ½ä½¿ç”¨äº†ä¸€è‡´çš„é¢œè‰²æ–¹æ¡ˆæ¥åŒºåˆ†ä¸åŒçš„å±‚çº§å’Œç»„ä»¶ï¼š

- ğŸ”µ è“è‰²ï¼šåº”ç”¨å±‚å’ŒLuaç›¸å…³ç»„ä»¶
- ğŸŸ£ ç´«è‰²ï¼šskynetæ ¸å¿ƒå±‚ç»„ä»¶
- ğŸŸ¢ ç»¿è‰²ï¼šsocket_serverå±‚å’ŒCå±‚ç»„ä»¶
- ğŸŸ  æ©™è‰²ï¼šIOå¤šè·¯å¤ç”¨å’Œç³»ç»Ÿè°ƒç”¨
- ğŸ”´ çº¢è‰²ï¼šé”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µ
- ğŸŸ¡ é»„è‰²ï¼šå†³ç­–ç‚¹å’Œæ¡ä»¶åˆ¤æ–­

## å›¾è¡¨å…³ç³»

è¿™äº›å›¾è¡¨æŒ‰ç…§ä»å®è§‚åˆ°å¾®è§‚çš„é¡ºåºç»„ç»‡ï¼š
1. **æ¶æ„å›¾**ï¼šæ•´ä½“æ¶æ„æ¦‚è§ˆ
2. **çŠ¶æ€æœº**ï¼šsocketçŠ¶æ€ç®¡ç†
3. **æµç¨‹å›¾**ï¼šæ•°æ®æ”¶å‘æµç¨‹
4. **ç»“æ„å›¾**ï¼šå†…éƒ¨æ•°æ®ç»“æ„
5. **äº¤äº’å›¾**ï¼šçº¿ç¨‹é—´äº¤äº’
6. **ç®¡ç†å›¾**ï¼šIDå’Œç¼“å†²åŒºç®¡ç†

æ¯ä¸ªå›¾è¡¨éƒ½å¯ä»¥ç‹¬ç«‹ç†è§£ï¼ŒåŒæ—¶ç›¸äº’è¡¥å……å½¢æˆå®Œæ•´çš„ç½‘ç»œå±‚æ¶æ„å›¾è°±ã€‚

## æ›´æ–°æ—¥å¿—

- 2025-09-27ï¼šåˆ›å»ºåˆå§‹ç‰ˆæœ¬çš„8ä¸ªç½‘ç»œå±‚å›¾è¡¨
- åŒ…å«è¯¦ç»†çš„æ¶æ„ã€æµç¨‹ã€æ•°æ®ç»“æ„å’Œç®¡ç†æœºåˆ¶å›¾